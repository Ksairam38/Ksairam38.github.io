<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SignalRClient</title>
    <style>
        .inbox-container {
            display: flex;
            justify-content: space-between;
        }
        .contact-container {
            width: 30%;
            margin-right: 20px;
        }
        .conversation-container {
            width: 60%;
        }
        .contact {
            cursor: pointer;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .contact:hover {
            background-color: #eaeaea;
        }
        .conversation {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h2>Data loaded from the Web API:</h2>
    <div class="inbox-container">
        <div id="contactsContainer" class="contact-container"></div>
        <div id="conversationsContainer" class="conversation-container"></div>
    </div>

    <div id="offersContainer" class="alert alert-warning" role="alert"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.0/signalr.min.js"></script>
    <script>
        const offersContainer = document.getElementById("offersContainer");
        const userData = {
            businessId: "99969011-7b1d-4c2d-92a6-fba9ca31a261",
            userId: "087d89ca-2d1e-4edf-b849-772b811daa25",
            operations: {}
        };
        const contactsContainer = document.getElementById("contactsContainer");
        const conversationsContainer = document.getElementById("conversationsContainer");

        // Function to generate HTML for a single contact
        function generateContactHTML(contact) {
            return `
                <div class="contact" onclick="loadConversation('${contact.contact}', '${userData.businessId}')">
                    <p>Contact: ${contact.contact}</p>
                    <p>Name: ${contact.name}</p>
                    <p>Chat Status: ${contact.chatStatus}</p>
                    <p>Assignee: ${contact.assignee}</p>
                </div>
            `;
        }
        
        // Function to generate HTML for a single conversation
        function generateConversationsHTML(conversation) {
            return `
                <div class="conversation">
                    <p> ${conversation.TextMessage}</p>
                </div>
            `;
        }

        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("https://newbrassrock76.conveyor.cloud/conversations")
            .build();

        hubConnection.start()
            .then(() => {
                console.log("Connection started!");
                // Send the userData object to the server after connection is established
                hubConnection.invoke("SendUserData", userData);
            })
            .catch(() => {
                console.log("Connection failed");
            });
            
        hubConnection.on("SendContacts", (data) => {
            console.log(data);
            contactsContainer.innerHTML = "";
            // Loop through the received data and generate HTML for each contact
            data.forEach(contact => {
                const contactHTML = generateContactHTML(contact);
                contactsContainer.insertAdjacentHTML("beforeend", contactHTML);
            });
            // Handle received data here, for example, update UI with the received data
        });
        
        hubConnection.on("SendConversations", (data) => {
            console.log(data);
            conversationsContainer.innerHTML = "";
            // Loop through the received data and generate HTML for each conversation
            data.forEach(conversation => {
                const conversationHTML = generateConversationsHTML(conversation);
                conversationsContainer.insertAdjacentHTML("beforeend", conversationHTML);
            });
            // Handle received data here, for example, update UI with the received data
        });

        hubConnection.on("ReceiveMessageFromServer", (data) => {
            console.log(data);
            conversationsContainer.innerHTML += data;
            // Handle received data here, for example, update UI with the received data
        });
        
        // Function to load conversation for a contact
      function loadConversation(contact, businessId) {
    console.log(`Loading conversation for contact: ${contact}`);
    
    // Call the server method to leave all existing groups
    hubConnection.invoke("LeaveGroup")
        .then(() => {
            console.log(`Successfully left all groups.`);
            
            // Now join the group with the specified contact
            hubConnection.invoke("JoinGroup", contact, businessId)
                .then(() => {
                    console.log(`Successfully joined group for contact ${contact}`);
                })
                .catch((error) => {
                    console.error(`Error joining group for contact ${contact}:`, error);
                });
        })
        .catch((error) => {
            console.error(`Error leaving groups:`, error);
        });
               
        }
    </script>
</body>
</html>
