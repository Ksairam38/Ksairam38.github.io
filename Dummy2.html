<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SignalRClient</title>
    <style>
        .inbox-container {
            display: flex;
            justify-content: space-between;
        }
        .contact-container {
            width: 30%;
            margin-right: 20px;
        }
        .conversation-container {
            width: 60%;
        }
        .contact {
            cursor: pointer;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .contact:hover {
            background-color: #eaeaea;
        }
        .conversation {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h2>Data loaded from the Web API:</h2>
    <div class="inbox-container">
        <div id="contactsContainer" class="contact-container"></div>
        <div id="conversationsContainer" class="conversation-container"></div>
    </div>


    <div>
        <h3>Send Text Message</h3>
        <div>
            <input type="text" id="textMessage" placeholder="Enter text message" />
            <button onclick="sendTextMessage()">Send Text Message</button>
        </div>
    </div>
    <div>
        <h3>Send Media Message</h3>
        <div>
            <input type="file" id="mediaFile" accept=".jpg, .jpeg, .png, .gif" />
            <input type="text" id="mediaCaption" placeholder="Enter caption" />
            <button onclick="sendMediaMessage()">Send Media Message</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.0/signalr.min.js"></script>
    <script>
   
        const userData = {
            businessId: "99969011-7b1d-4c2d-92a6-fba9ca31a261",
            userId: "3ebe2f86-93b8-4b13-906f-6d17a31f91c3",
            operations: {}
        };
        const contactsContainer = document.getElementById("contactsContainer");
        const conversationsContainer = document.getElementById("conversationsContainer");

        // Function to generate HTML for a single contact
        function generateContactHTML(contact) {
            return `
                <div class="contact" onclick="loadConversation('${contact.contact}', '${userData.businessId}')">
                    <p>Contact: ${contact.contact}</p>
                    <p>Name: ${contact.name}</p>
                    <p>Chat Status: ${contact.chatStatus}</p>
                    <p>Assignee: ${contact.assignee}</p>
                    <p>LastMessageAt: ${contact.lastMessageAt}</p>
                     <p>LastMessage: ${contact.lastMessage}</p>
                    <p>UnRead: ${contact.unRead}</p>
                </div>
            `;
        }
        
        // Function to generate HTML for a single conversation
        function generateConversationsHTML(conversation) {
            return `
                <div class="conversation">
                    <p> ${conversation.TextMessage}</p>
                </div>
            `;
        }

        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("https://biggreenroof70.conveyor.cloud/conversations")
             .withAutomaticReconnect()  
            .build();

        hubConnection.start()
            .then(() => {
                console.log("Connection started!");
                // Send the userData object to the server after connection is established
                hubConnection.invoke("SendUserData", userData);
            })
            .catch(() => {
                console.log("Connection failed");
            });
            
        hubConnection.on("SendContacts", (data) => {
            console.log(data);
            contactsContainer.innerHTML = "";
            // Loop through the received data and generate HTML for each contact
            data.forEach(contact => {
                const contactHTML = generateContactHTML(contact);
                contactsContainer.insertAdjacentHTML("beforeend", contactHTML);
            });
            // Handle received data here, for example, update UI with the received data
        });
        
        hubConnection.on("SendConversations", (data) => {
            console.log(data);
            conversationsContainer.innerHTML = "";
            // Loop through the received data and generate HTML for each conversation
            data.forEach(conversation => {
                const conversationHTML = generateConversationsHTML(conversation);
                conversationsContainer.insertAdjacentHTML("beforeend", conversationHTML);
            });
            // Handle received data here, for example, update UI with the received data
        });

        hubConnection.on("ReceiveMessageFromServer", (data) => {
              console.log(data);
    conversationsContainer.innerHTML += `<div class="conversation">${data.TextMessage}</div>`;
    const messageId = data.id;
    const businessId = userData.businessId;

    // Invoke SendUserData before and after MarkAsRead
    hubConnection.invoke("SendUserData", userData)
        .then(() => {
            console.log('User data sent before marking as read');
            return hubConnection.invoke("MarkAsRead", messageId, businessId);
        })
        .then(() => {
            console.log('Message marked as read');
            return hubConnection.invoke("SendUserData", userData);
        })
        .then(() => {
            console.log('User data sent after marking as read');
        })
        .catch((error) => {
            console.error('Error occurred:', error);
        });
        });

        
        // Function to load conversation for a contact
      function loadConversation(contact, businessId) {
    console.log(`Loading conversation for contact: ${contact}`);
    
    // Call the server method to leave all existing groups
    hubConnection.invoke("LeaveGroup")
        .then(() => {
            console.log(`Successfully left all groups.`);
            
            // Now join the group with the specified contact
            hubConnection.invoke("JoinGroup", contact, businessId)
                .then(() => {
                    console.log(`Successfully joined group for contact ${contact}`);
                });
        });
    }
hubconnection.onreconnected(connectionId => {
            console.log(`Connection reestablished. Connected with connectionId "${connectionId}".`);
           hubConnection.invoke("SendUserData", userData);
        });
    // Function to send text message
    function sendTextMessage() {
        const textMessage = document.getElementById("textMessage").value;
        const data = {
            Contact: ["919848732198"], // List of contacts (replace with actual contacts)
            TextMessage: textMessage
        };

        hubConnection.invoke("SendTextOrEmojiMessage", data, userData.businessId)
            .then(() => {
                console.log("Text message sent successfully.");
                // Optionally, update UI or display a success message
            });
    }

    // Function to send media message
function sendMediaMessage() {
    const mediaFile = document.getElementById("mediaFile").files[0];
    const mediaCaption = document.getElementById("mediaCaption").value;
    const reader = new FileReader();
      const   Contact=  ["919848732198"];
    reader.onload = function () {
        const base64File = reader.result.split(",")[1]; // Extracting base64 data from result
      
        hubConnection.invoke("SendMediaMessage",Contact,base64File,mediaCaption,mediaFile.name,userData.businessId)
            .then(() => {
                console.log("Media message sent successfully.");
                // Optionally, update UI or display a success message
            });
    }; // Closing brace for the reader.onload function
    
    // Start reading the file
    reader.readAsDataURL(mediaFile);
} // Closing brace for the sendMediaMessage function


    </script>
</body>
</html>
